---
title: "登录服務器設計"
date: 2018-10-29T:13:01+08:00
draft: false
---

# 登录服务器设计

## 设计目标

  登录服务器实现客户端认证,以及成功后的 token 发放,之后把客户端导航到逻辑服务器,逻辑服务器再到登录服务器验证客户端连接的合法性,完成登录过程.

## 流程与功能细节

1. 客户注册。 应该支持多种注册方式, 邮箱,手机,游客等
2. 逻辑服务器心跳。 逻辑服务器报告状态,实现导航时的负载均衡.
3. 登录。 验证后保留最后登录时间和 token，就是一个 expirable token .
4. 登出。 根据预定义策略删除 token
5. 逻辑服务器查询。 逻辑服务器验证 token 有效性. 有效允许用户操作
6. 登录服务器的负载均衡。 通过 DNS 做负载均衡。
7. 忘记密码。

## 接口

0. 获取 cookie
	url: /cookie
	method: GET
	return:
	{
		"cookie": "2343rfdsdf"
	}

1. 注册 
   url: /register
   method: POST
   json:
   	{
   		"type": 1,
   		"email": "xxx@yyy.com",
   		"passwd": "#####",
   		"cookie": "23434544"
   	}

   	return:
   	{
   		"result": 1,
   		"errmsg": ""
   	}

2. 逻辑服务器心跳
	url: /report
	method: POST
	json:
	 {
	 	"service": "192.168.0.15:3333",
	 	"cap": 1000,
	 	"active": 56,
	 	"cpu_num": 2,
	 	"mem_total": 8000, // M
	 	"cpu_usage": 56,
	 	"mem_usage": 1000  // M
	 }
	return:
	 {
	 	"result": 1
	 }

3. 逻辑服务器查询
	url: /verify
	method: POST
	json:
	{
		"user": "asfdf",
		"token": "fasdfsfjslkdfkls"
	}
	return:
	{
		"result": 1,
		"user": "asfdf",
		"avatar": "http://header1.com/2.png",
		"gender": 1,
		"email": "xxx@yyy.com"
		"phone": "13788784523",
	}

4. 登录

	url: /login
	method: POST
	json:
	{
		"type": 1
		"email": "xxx@yyy.com",
		"passwd": "23434"
	}
	return:
	{
		"result": 1,
		"errmsg": "fdsf",
		"token": "werwerfsdf",
		"redirect": "192.168.0.3:3333"
	}

5. 忘记密码

	url: /recover?type=1&email=yy@xx.com
	method: GET
	json:
	{}
	return:
	{
		"result": 1,
		"errmsg": "xxx",
		"msg": "yyy"
	}

6. 登出
	url: /logout
	method:POST
	json:
	{
		"user": "asdf",
	}
	return:
	{
		"result": 1,
		"errmsg": "xxx"
	}