---
title: "桌游服務器設計"
date: 2018-10-24T:22:27+08:00
draft: false
---

# 桌游服務器設計


## 思路

常見的 gate, game, web, db 多進程分佈式設計，之間基於 rpc 通信，通信格式同 gate 與客戶端一致即可，msgpack 或 protobuf

## 進程和組件

- zookeeper: 提供分佈式環境的協調服務。
	
	1. 配置管理 變更監聽
	2. 分佈式鎖
	3. 服務看門狗

- login: 多個登陸服務器部署，在 dns 上做負載均衡。

	1. 完成用戶驗證后，分發用戶 token，是用戶可以登錄 gate.
	2. 把用戶重定向到負載比較低的 gate
	3. (用戶首次連接 gate，參數帶上 token，login id, gate 使用這些參數加上 uid 到 login id 的 login 上驗證)

- gate： 客戶端接入，消息路由。也可能位於防火墻或網關之後。

	1. 客戶端接入，分佈式部署。 需要瞭解所有其他所有服務的地址。
	2. 消息路由需要解包頭，根據 cmd 字段和 gameId 字段路由
	3. gameId 規則， x * 1000 + y ： x 表示游戲類型， y 表示場次等子類型

- game: 多種游戲， 每個多個場次， 每個場次都可以多進程負載均衡

- lobby: 大廳服務，多進程負載均衡，完成和具體游戲無關的邏輯

- redis: 可以支持集群，服務器可直接訪問 redis， 需要返回值的數據查詢操作通通 redis。 單獨的進程負責 redis 到 mysql 的落地和冗餘

- mysql: 表存儲 hash 存儲，主要用於數據冗餘存儲，異地容災。

- kafka: 系統日志，系統事件 hook 子系統等。解耦生產和消費。

- web: REST 接口，主要用於外部主動和系統的通信

## 其他

1. rpc: 使用基於 zeromq 的方案

2. event: 注冊和回調

3. timer: 

4. callLater: 

5. log: 帶模塊，文件，行信息，json 格式指示關鍵信息。 從 level 上可分爲 debug 那麽幾種，從邏輯上可分爲用戶相關，系統相關，組建相關等。

	日志進入 kafka ，分析系統消費。